{
  "name": "marketing_rmn",
  "displayName": "Marketing (Retail Media)",
  "version": "1.0",
  "description": "Complete decision stack for retail media marketing optimization across Amazon, Walmart, and Target",
  "function": "marketing",
  "enabled": true,
  
  "terms": {
    "glossary": {
      "ROAS": "Return on Advertising Spend - Revenue / Spend",
      "Rank": "Search position for primary keyword on retailer site",
      "Share of Voice": "Percentage of impressions captured vs. competitors",
      "Availability": "In-stock rate across target fulfillment centers"
    },
    "kpis": [
      {
        "name": "ROAS",
        "ontology_concept": "ex:ROAS",
        "calculation": "revenue / spend",
        "target": 2.5,
        "threshold_warning": 2.0,
        "threshold_critical": 1.5,
        "unit": "ratio"
      },
      {
        "name": "Rank",
        "ontology_concept": "ex:Rank",
        "calculation": "search_position_for_primary_keyword",
        "target": 3,
        "threshold_warning": 5,
        "threshold_critical": 10,
        "unit": "position"
      },
      {
        "name": "Availability",
        "ontology_concept": "ex:Availability",
        "calculation": "in_stock_fcs / total_fcs",
        "target": 0.95,
        "threshold_warning": 0.85,
        "threshold_critical": 0.75,
        "unit": "percentage"
      }
    ],
    "ontology_concepts": [
      "ex:ROAS",
      "ex:Rank",
      "ex:ShareOfVoice",
      "ex:Availability",
      "ex:ASIN",
      "ex:CampaignDecision",
      "ex:Budget"
    ]
  },
  
  "patterns": [
    {
      "name": "rank_slide",
      "displayName": "Rank Slide Detection",
      "description": "Detect when product rank drops significantly",
      "detection": {
        "event_type": "RankChange",
        "conditions": [
          "rank_current > rank_target + 3",
          "asin IN top_20_list"
        ],
        "data_sources": ["amazon_ads_api", "walmart_connect_api", "target_roundel_api"],
        "check_frequency": "hourly"
      },
      "severity": "high",
      "confidence_threshold": 0.8,
      "linked_playbook": "protect_rank"
    },
    {
      "name": "oos_risk",
      "displayName": "Out of Stock Risk",
      "description": "Detect when availability falls below safe threshold during active campaigns",
      "detection": {
        "event_type": "AvailabilityChange",
        "conditions": [
          "availability < 0.85",
          "campaign_status = 'active'",
          "daily_budget > 1000"
        ],
        "data_sources": ["inventory_feed", "campaign_performance"],
        "check_frequency": "every_4_hours"
      },
      "severity": "high",
      "confidence_threshold": 0.9,
      "linked_playbook": "pause_low_supply_placements"
    },
    {
      "name": "tentpole_surge",
      "displayName": "Tentpole Event Preparation",
      "description": "Prepare for major shopping events (Prime Day, Black Friday)",
      "detection": {
        "event_type": "CalendarEvent",
        "conditions": [
          "event_type IN ['prime_day', 'black_friday', 'cyber_monday']",
          "days_until <= 14"
        ],
        "data_sources": ["calendar_events"],
        "check_frequency": "daily"
      },
      "severity": "medium",
      "confidence_threshold": 1.0,
      "linked_playbook": "scale_spend_by_availability"
    },
    {
      "name": "post_promo_dip",
      "displayName": "Post-Promotion Dip",
      "description": "Detect sales decline after promotion ends",
      "detection": {
        "event_type": "SalesTrend",
        "conditions": [
          "promo_ended_days_ago <= 7",
          "sales_decline_pct > 0.15"
        ],
        "data_sources": ["sales_data", "promotion_calendar"],
        "check_frequency": "daily"
      },
      "severity": "medium",
      "confidence_threshold": 0.75,
      "linked_playbook": "smooth_transition"
    }
  ],
  
  "models": {
    "llm_config": {
      "system_prompt": "You are a retail media expert specializing in Amazon, Walmart, and Target advertising. You optimize ROAS while respecting availability constraints. Always provide SKU/ASIN-level recommendations with rank preservation logic. Consider cross-channel effects and retailer-specific nuances.",
      "temperature": 0.3,
      "max_tokens": 2000,
      "retailer_context": ["amazon", "walmart", "target", "instacart"]
    },
    "forecast_models": [
      {
        "type": "time_series",
        "algorithm": "prophet",
        "features": ["sales_history", "seasonality", "promotions", "holidays"],
        "horizon_days": 90
      },
      {
        "type": "causal_inference",
        "algorithm": "uplift_modeling",
        "treatment": "ad_spend_increase",
        "outcome": "rank_improvement"
      }
    ],
    "optimization_models": [
      {
        "type": "portfolio_optimization",
        "objective": "maximize_roas",
        "constraints": ["availability >= 0.85", "min_budget_per_asin >= 50"]
      }
    ]
  },
  
  "entities": {
    "primary": ["ASIN", "Family", "Campaign"],
    "related": ["FC", "Region", "Budget", "Calendar", "Keyword"],
    "relationships": [
      "ASIN -> Family (belongs_to)",
      "ASIN -> FC (stocked_at)",
      "Campaign -> ASIN (targets)",
      "Campaign -> Budget (allocates_from)",
      "Campaign -> Keyword (bids_on)"
    ],
    "ontology_view": "marketing_entity_graph",
    "cross_system_mappings": {
      "ASIN": {
        "walmart": "item_id",
        "target": "tcin",
        "erp": "sku"
      }
    }
  },
  
  "plays": [
    {
      "name": "protect_rank",
      "displayName": "Protect Top-20 Rank",
      "description": "Increase spend to protect rank with availability checks",
      "playbook_file": "protect_rank.yaml",
      "template_id": null,
      "sla_hours": 4,
      "auto_execute": false,
      "requires_approval_above_usd": 5000
    },
    {
      "name": "pause_low_supply_placements",
      "displayName": "Pause Low-Supply Placements",
      "description": "Pause ad placements when availability drops",
      "playbook_file": "pause_low_supply.yaml",
      "template_id": null,
      "sla_hours": 1,
      "auto_execute": true,
      "requires_approval_above_usd": 0
    },
    {
      "name": "scale_spend_by_availability",
      "displayName": "Scale Spend for Tentpole",
      "description": "Scale advertising spend based on availability forecast",
      "playbook_file": "scale_spend_tentpole.yaml",
      "template_id": null,
      "sla_hours": 24,
      "auto_execute": false,
      "requires_approval_above_usd": 10000
    }
  ],
  
  "prompts": {
    "rank_protection_template": {
      "description": "Template for rank protection decisions",
      "required_inputs": ["asin", "rank_current", "rank_target", "availability", "current_roas"],
      "expected_outputs": ["spend_increase_pct", "pause_placements", "confidence", "rationale"],
      "template": "Given ASIN {{asin}} has dropped from rank {{rank_target}} to {{rank_current}}, with availability at {{availability}} and current ROAS of {{current_roas}}, determine the optimal spend increase to restore rank while maintaining profitability."
    },
    "availability_check_template": {
      "description": "Check if availability supports increased spend",
      "required_inputs": ["asin", "availability", "target_regions", "forecast_days"],
      "expected_outputs": ["can_increase_spend", "max_safe_increase_pct", "risk_factors"],
      "template": "Analyze availability of {{asin}} at {{availability}} across {{target_regions}}. Forecast {{forecast_days}} days ahead. Can we safely increase spend?"
    }
  },
  
  "crew": {
    "manager": "mco-orchestration-manager",
    "workers": [
      "budget-optimizer",
      "bid-target-setter",
      "attribution-causal",
      "feature-forecast"
    ],
    "mode": "hierarchical"
  },
  
  "governance": {
    "constraints": [
      {
        "type": "spend",
        "field": "budget_increase_pct",
        "operator": "lte",
        "value": 0.20,
        "severity": "block",
        "message": "Budget increase cannot exceed 20%"
      },
      {
        "type": "spend",
        "field": "daily_budget_usd",
        "operator": "lte",
        "value": 10000,
        "severity": "approve",
        "message": "Daily budget exceeds $10,000 - requires approval"
      },
      {
        "type": "service_level",
        "field": "availability",
        "operator": "gte",
        "value": 0.85,
        "severity": "block",
        "message": "Cannot increase spend when availability < 85%"
      }
    ],
    "approval_workflows": {
      "campaign_budget": {
        "specialist": 5000,
        "manager": 25000,
        "director": 100000,
        "admin": 999999
      },
      "creative_changes": {
        "specialist": 2000,
        "manager": 10000,
        "director": 50000
      }
    },
    "rate_limits": {
      "max_actions_per_hour": 50,
      "max_actions_per_day": 200,
      "max_concurrent": 10
    }
  },
  
  "integration": {
    "data_sources": [
      {
        "name": "Amazon Advertising API",
        "type": "rest_api",
        "endpoint": "${AMAZON_ADS_ENDPOINT}",
        "auth": "oauth2",
        "refresh_frequency": "hourly"
      },
      {
        "name": "Walmart Connect API",
        "type": "rest_api",
        "endpoint": "${WALMART_CONNECT_ENDPOINT}",
        "auth": "api_key",
        "refresh_frequency": "hourly"
      },
      {
        "name": "Target Roundel API",
        "type": "rest_api",
        "endpoint": "${TARGET_ROUNDEL_ENDPOINT}",
        "auth": "oauth2",
        "refresh_frequency": "hourly"
      },
      {
        "name": "Inventory Feed",
        "type": "sftp",
        "endpoint": "${INVENTORY_SFTP}",
        "refresh_frequency": "every_4_hours"
      }
    ],
    "event_streams": [
      "stream:marketing:rank-change",
      "stream:marketing:availability-change",
      "stream:marketing:campaign-performance"
    ],
    "output_destinations": [
      "mesh:commands",
      "decisions_table",
      "slack_notifications"
    ]
  },
  
  "deployment": {
    "prerequisites": [
      "Amazon Ads API credentials configured",
      "Walmart Connect API key set",
      "Target Roundel OAuth configured",
      "Inventory feed access granted",
      "Redis Streams running",
      "CrewAI agents registered"
    ],
    "setup_steps": [
      "register_ontology_concepts",
      "create_event_patterns",
      "deploy_playbooks",
      "register_crew",
      "create_governance_policy",
      "warm_caches",
      "start_monitoring"
    ],
    "validation_checks": [
      "ontology_concepts_exist",
      "playbooks_loadable",
      "agents_responsive",
      "data_sources_accessible",
      "governance_constraints_valid"
    ]
  }
}
