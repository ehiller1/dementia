{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.mesh/EventPayload.json",
  "title": "Intelligence Mesh Event Payload",
  "description": "Unified payload schema for all Intelligence Mesh events",
  "type": "object",
  "oneOf": [
    { "$ref": "#/$defs/Observation" },
    { "$ref": "#/$defs/Recommendation" },
    { "$ref": "#/$defs/Decision" },
    { "$ref": "#/$defs/Action" },
    { "$ref": "#/$defs/Outcome" },
    { "$ref": "#/$defs/Anomaly" },
    { "$ref": "#/$defs/Audit" }
  ],
  "$defs": {
    "EntityRef": {
      "type": "object",
      "properties": {
        "entityType": { "type": "string" },
        "entityId": { "type": "string" }
      },
      "required": ["entityType", "entityId"],
      "additionalProperties": false
    },
    "Constraint": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "operator": {
          "type": "string",
          "enum": ["<", "<=", ">", ">=", "==", "IN", "NOT_IN", "BETWEEN"]
        },
        "value": {}
      },
      "required": ["name", "operator", "value"],
      "additionalProperties": false
    },
    "Observation": {
      "type": "object",
      "properties": {
        "@context": { "type": "object" },
        "kind": { "type": "string", "const": "observation" },
        "subject": { "$ref": "#/$defs/EntityRef" },
        "attributes": { "type": "object" },
        "timestamp": { "type": "string", "format": "date-time" }
      },
      "required": ["kind", "subject"],
      "additionalProperties": false
    },
    "Recommendation": {
      "type": "object",
      "properties": {
        "@context": { "type": "object" },
        "kind": { "type": "string", "const": "recommendation" },
        "subject": { "$ref": "#/$defs/EntityRef" },
        "options": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "label": { "type": "string" },
              "payload": { "type": "object" },
              "score": { "type": "number" }
            },
            "required": ["payload", "score"],
            "additionalProperties": false
          }
        },
        "objective": { "type": "string" },
        "constraints": {
          "type": "array",
          "items": { "$ref": "#/$defs/Constraint" }
        }
      },
      "required": ["kind", "subject", "options"],
      "additionalProperties": false
    },
    "Decision": {
      "type": "object",
      "properties": {
        "@context": { "type": "object" },
        "kind": { "type": "string", "const": "decision" },
        "subject": { "$ref": "#/$defs/EntityRef" },
        "choice": { "type": "object" },
        "rationale": { "type": "string" },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "policyRef": { "type": "string", "format": "uri" },
        "validFrom": { "type": "string", "format": "date-time" },
        "validTo": { "type": "string", "format": "date-time" }
      },
      "required": ["kind", "subject", "choice"],
      "additionalProperties": false
    },
    "Action": {
      "type": "object",
      "properties": {
        "@context": { "type": "object" },
        "kind": { "type": "string", "const": "action" },
        "target": { "$ref": "#/$defs/EntityRef" },
        "operation": { "type": "string" },
        "params": { "type": "object" }
      },
      "required": ["kind", "target", "operation"],
      "additionalProperties": false
    },
    "Outcome": {
      "type": "object",
      "properties": {
        "@context": { "type": "object" },
        "kind": { "type": "string", "const": "outcome" },
        "subject": { "$ref": "#/$defs/EntityRef" },
        "metrics": { "type": "object" },
        "causedBy": { "type": "string" }
      },
      "required": ["kind", "subject", "metrics"],
      "additionalProperties": false
    },
    "Anomaly": {
      "type": "object",
      "properties": {
        "@context": { "type": "object" },
        "kind": { "type": "string", "const": "anomaly" },
        "subject": { "$ref": "#/$defs/EntityRef" },
        "message": { "type": "string" },
        "severity": {
          "type": "string",
          "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"]
        }
      },
      "required": ["kind", "subject", "message", "severity"],
      "additionalProperties": false
    },
    "Audit": {
      "type": "object",
      "properties": {
        "@context": { "type": "object" },
        "kind": { "type": "string", "const": "audit" },
        "action": {
          "type": "string",
          "enum": ["APPROVED", "REJECTED", "ROLLED_BACK"]
        },
        "reason": { "type": "string" },
        "performedBy": { "type": "string" }
      },
      "required": ["kind", "action", "performedBy"],
      "additionalProperties": false
    }
  }
}
